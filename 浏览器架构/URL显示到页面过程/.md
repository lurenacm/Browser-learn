## URL 输入到页面显示的过程发生了什么
> 从在浏览器中输入到页面显示的过程主要经历下面几件事
* 1. 查找强缓存。如果命中强缓存直接返回资源
* 2. 查找 DNS 缓存。没有缓存则将域名解析成 IP 地址，因为数据包需要通过IP地址传送。
* 3. TCP 连接。需要三次握手，连接成功后数据可以开始传输
* 4. 发送 HTTP 请求。携带请求的方法，请求头，HTTP 版本，URL 发送给服务器
* 5. 服务器处理请求并返回 HTTP 报文
* 6. 断开 TCP 连接。需要四次挥手。如果是响应头中有 `connection:keep-alive` HTTP1.1，则不断开连接
* 7. 浏览器开始渲染。将`HTML`构建成 `DOM树`，将 CSS构建成 `CSSOM树 CSS Object Model`。最后生成一个 `render tree`，浏览器根据 `render tree` 生成页面

### DNS 解析 (Domain Name System)
> 将域名解析成 IP 地址，因为数据包需要通过 IP 地址传送。每一次解析都会花费 20-120 毫秒
* 第一次输入地址后，浏览器会将域名进行一次 `DNS解析`，将解析后 的结果缓存下来。
* 第二次再次输入地址，`DNS解析` 会从本地缓存中 `递归查询`，如果本地缓存没有会开始 `迭代查询`。

#### 递归查询
> 所谓递归查询是指：浏览器会先从本地缓存中查找 `DNS解析后的缓存`，到本地的 `hosts文件` 查找，到本地的 `DNS解析器缓存` 查找，最后找到 `本地DNS服务器` 查找。在上面的任一个步骤中能找到则直接使用。如果在 `本地DNS服务器` 也没有找到，就会开始 `迭代查询`。

#### 迭代查询
[DNS迭代查询](./img/DNS迭代查询.jpg)
> 所谓的迭代查询是指：以本地 `DNS` 服务器为中心，分别向 `根域名服务器，顶级域名服务器，权威域名服务器` 查找信息后返回给浏览器的过程。这是一次新的 `DNS解析` 过程

#### DNS优化
* DNS 预解析。预解析是利用了 `link` 标签的异步加载 `rel="dns-prefetch"`，在页面渲染的时，同时实现 `DNS` 的解析，在需要某些资源时不需要再次解析。
[DNS 预解析](./img/dns-prefetch.jpg)
* 减少 DNS 的解析次数。尽可能少的去请求不同服务器和域名。
> 但是现在的大型项目往往采用多台服务器的方式部署，比如将图片类的静态资源存放图片服务器上。数据接口存放在数据接口服务器。`html/css/js` 文件资源存放在web服务器中等等。增加了 `DNS解析` 的次数，但是带来更多的优势，比如 `合理分配了服务器资源` 可以提高并发量，
[多台服务器部署](./img/分布式部署.png)

### TCP 连接
> TCP 的连接需要三次握手
* 第一次握手：建立连接。客户端向服务器发送一个请求的 `SYN` 报文。将`SYN`设置为1，初始序号Sequence Number为x(seq=x)，客户端处于`syn_send` 状态，等待服务器确认。
* 第二次握手：服务器接收 `SYN报文` 后会向客户端发送自己的 `SYN报文` 作为应答。服务器此时处于 `SYN_RCVD` 状态
* 第三次握手：客户端收到服务器的 SYN 报文后，会向服务器发送一个 ACK 报文。此时客户端和服务器都处于ESTABLISHED状态，完成TCP三次握手。


### 发送 HTTP 请求
* TCP 连接成功后，服务器可以接收到请求了。服务器在接收请求后会分析请求头的信息，查看是否有命中协商缓存，即请求头中是否有 `if-Modified-Since/ If-None-Match`，如果有而且还有效就直接返回缓存的结果响应`304`，如果无效就重新返回资源响应`200`。


### TCP 断开
> TCP 的断开需要四次挥手。
* 
[四次挥手](https://juejin.cn/post/6844903958624878606#heading-6)

#### 为什么连接是三次握手，断开时是四次挥手?
* 四次挥手的原因是客户端向服务器发送关闭请求 `FIN` 后，服务器接收到 `FIN报文` 后，为了防止响应的时间过程会先发送一次应答给客户端，等到服务器将所有数据发送给客户端，客户端接收后应答服务器。


## 参考
[TCP 三次握手和四次挥手](https://juejin.cn/post/6844903958624878606)










